<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="Bo Zhao, Benji Antolin">
  <title>Local Changes</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
  <link href="https://fonts.googleapis.com/css?family=Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Oswald&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.14/c3.min.css" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.css" />
  <!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.min.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.css"> -->
  <link rel="stylesheet" href="css/simplebar.css" />
  <link rel="stylesheet" href="css/main.css">
  <!-- <link rel="stylesheet" href="css/case2.css"> -->
  <link rel="icon" href="img/favicon.ico" type="image/x-icon" />
  <script src="https://unpkg.com/d3@5/dist/d3.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.6.14/c3.min.js"></script>
  <!-- <script src="https://d3js.org/d3.v5.min.js"></script> -->
  <!-- <script src="https://dc-js.github.io/dc.js/js/crossfilter.js"></script>
  <script src="https://dc-js.github.io/dc.js/js/dc.js"></script> -->
  <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
  <!-- <script src="js/leaflet.heat.js"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js"></script>
  <script src="js/simplebar.min.js"></script>
  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.min.js"></script> -->
</head>

<body>
  <main>
    <div id="info" class="">
      <div id="title"><i class="fas fa-medkit"></i> 2019 Coronavirous Map
        <span><a href="https://www.facebook.com/TurfgrassWaterConservationAlliance/" target="_blank"><i class="fab fa-facebook"></i></a></span>
        <span><a href="https://twitter.com/_tgwca" target="_blank"><i class="fab fa-twitter-square"></i></a></span>
        <span><a data-toggle="modal" data-target="#disclaimer"><i class="nav fas fa-question-circle"></i></a></span>
      </div>

      <span id="date">Jan 25</span>
      <div id="timeline-chart"></div>
      <div class="card-deck counts">
        <div class="card">
          <div class="card-body confirmed">
            <h5 class="card-title">Confirmed</h5>
            <p class="card-text">5678</p>
          </div>
        </div>

        <div class="card">
          <div class="card-body suspected">
            <h5 class="card-title">Suspected</h5>
            <p class="card-text">5678</p>
          </div>
        </div>
        <div class="card">
          <div class="card-body recovered">
            <h5 class="card-title">Recovered</h5>
            <p class="card-text">5678</p>
          </div>
        </div>

        <div class="card">
          <div class="card-body death">
            <h5 class="card-title">Death</h5>
            <p class="card-text">5678</p>
          </div>
        </div>
      </div>

      <div class="card-deck legend">
        <div class="card">
          <div class="card-body">
            <h5 class="card-title" style="color:gray; text-align:right"> Legend: </h5>

          </div>
        </div>

        <div class="card">
          <div class="card-body legend-color-1">
            <h5 class="card-title" style="color:black">0</h5>

          </div>
        </div>

        <div class="card">
          <div class="card-body  legend-color-2">
            <h5 class="card-title" style="color:black">10</h5>

          </div>
        </div>
        <div class="card">
          <div class="card-body  legend-color-3">
            <h5 class="card-title" style="color:black">25</h5>

          </div>
        </div>

        <div class="card">
          <div class="card-body  legend-color-4">
            <h5 class="card-title" style="color:black">50</h5>

          </div>
        </div>

        <div class="card">
          <div class="card-body legend-color-5">
            <h5 class="card-title" style="color:black">100+</h5>
          </div>
        </div>
      </div>



      <div id="timeline-chart"></div>
      <div id="total-chart"></div>
      <div id="rank-chart"></div>
      <div id="footer">
        <p style="font-size: 10pt">Data sources: WHO, CDC, NHC, JHU CSSE and Dingxiangyuan</p>
        <p style="font-size: 10pt">Supported by <a href="http://hgis.uw.edu">Humanistic GIS Lab at University of Washington - Seattle</a>.</p>
      </div>
    </div>

    <div id="map"></div>
  </main>

  <script>
    var createLabelIcon = function(labelClass, labelText) {
      return L.divIcon({
        className: labelClass,
        html: labelText
      })
    }
    var mymap = L.map('map', {
      center: [31.448, 105.765],
      zoomControl: false,
      zoom: 5.5,
      maxZoom: 16,
      minZoom: 1
    });


    new L.Control.Zoom({
      position: 'topright'
    }).addTo(mymap);



    var gray = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png').addTo(mymap);

    var streets = L.tileLayer('http://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}@2x.png');
    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    var baseLayers = {
      'Grayscale': gray,
      'Streets': streets,
      'Satellite': satellite
    }


    var chart, tchart, rchart;


    var colors = chroma.scale('YlOrRd').mode('lch').colors(7);
    for (i = 0; i < 5; i++) {
      $('head').append($("<style> .region-color-" + (i + 1).toString() + " { color: " + colors[i] + "; font-size: 15px; text-shadow: 0 0 3px #ffffff;} </style>"));
      $('head').append($("<style> .legend-color-" + (i + 1).toString() + " { background: " + colors[i] + "; font-size: 15px; text-shadow: 0 0 3px #ffffff;} </style>"));
    }


    Promise.all([
      d3.csv('assets/2019-nCoV.csv'),
      d3.json("assets/wuhan.geojson")
    ]).then(function(datasets) {


      function setColor(enname) {
        var id = 0;
        var pop = datasets[0][datasets[0].length - 1][enname];

        if (pop != undefined) {
          pop = +pop.toString().split("-")[0];

        } else {
          pop = 0;
        }

        console.log(pop);

        if (pop >= 100) {
          id = 4;
        } else if (pop > 50 && pop <= 99) {
          id = 3;
        } else if (pop > 25 && pop <= 50) {
          id = 2;
        } else if (pop > 10 && pop <= 25) {
          id = 1;
        } else {
          id = 0;
        }
        return colors[id];
      }


      function style(feature) {
        return {
          fillColor: setColor(feature.properties.enname),
          fillOpacity: 0.4,
          weight: 2,
          opacity: 1,
          color: '#b4b4b4',
          dashArray: '3'
        };
      }



      var provinces = L.geoJSON(datasets[1], {
        style: style
      }).addTo(mymap);

      // mymap.fitBounds(provinces.getBounds());


      // L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}@2x.png').addTo(mymap);

      // L.control.layers(provinces, {
      //   collapsed: false
      // }).addTo(mymap);

      var t = ["t"];
      var confirmed = ["Confirmed"];
      var suspected = ["Suspected"];
      var recovered = ["Recovered"];
      var death = ["Death"];
      var japan = ["Japan"];
      var southKorea = ["South Korea"];
      var thailand = ["Thailand"];



      datasets[0].forEach(function(d) {
        t.push(new Date(d["datetime"]))

        confirmed.push(+d["hubei"].split("-")[0])

        if (d["hubei"].split("-").length == 1) {
          suspected.push(0)
        } else {
          suspected.push(+d["hubei"].split("-")[1])
        }

      });

      latest = datasets[0][datasets[0].length - 1]
      japan.push(latest["japan"]);
      southKorea.push(latest["south korea"]);
      thailand.push(latest["thailand"]);


      chart = c3.generate({
        size: {
          width: 400
        },
        data: {
          x: "t",
          y: "confirmed",
          columns: [t, confirmed, suspected],
          type: 'spline',
          axes: {
            confirmed: 'y'
          }
        },
        axis: {
          x: {
            type: "timeseries",
            tick: {
              format: "%b %d",
              fit: true
            }
          },
          y: {
            label: {
              text: 'Total Pop.',
              position: 'outer-middle'
            }
          }
        },
        point: {
          r: 5,
          focus: {
            expand: {
              r: 2
            }
          }
        },
        zoom: {
          // rescale: true,
          enabled: false,
          type: "scroll",
          // onzoom: function(d) {
          //   tt(d);
          // }
        },
        tooltip: {
          linked: true,
        },
        legend: {
          position: 'inset',
          inset: {
            anchor: "top-left",
            y: 10,
          },
        },
        bindto: "#total-chart"
      });


      tchart = c3.generate({
        size: {
          height: 80,
          width: 380
        },
        data: {
          x: "t",
          columns: [t, confirmed],
          onmouseover: dailyUpdate,
          type: 'bar',
          labels: true,
          colors: {
            Confirmed: 'rgba(255, 255, 255, 0.8)',
          }
        },
        axis: {
          x: {
            type: "timeseries",
            tick: {
              format: "%b %d",
              fit: true
            }
          },
          y: {
            label: {
              text: 'Total Pop.',
              position: 'outer-middle'
            }
          }
        },
        area: {
          zerobased: false
        },
        tooltip: {
          show: false
        },
        legend: {
          show: false
        },
        point: {
          r: 5,
          focus: {
            expand: {
              r: 15
            }
          }
        },
        // zoom: {
        //   enabled: true,
        //   onzoomend: function(d) {
        //
        //   }
        //},
        bindto: "#timeline-chart"
      });


      $($($("#timeline-chart svg").children()[1]).children()[6]).hide();





      rchart = c3.generate({
        size: {
          height: 400,
          width: 380
        },
        data: {
          columns: [southKorea, thailand, japan],
          // onmouseover: dailyUpdate,
          type: 'bar',
          order: 'desc',
          labels: true,
          colors: {
            // Thailand: 'rgba(255, 255, 255, 0.8)',
          }
        },
        axis: {
          rotated: true
        },
        // axis: {
        //   x: {
        //     type: "timeseries",
        //     tick: {
        //       format: "%b %d",
        //       fit: true
        //     }
        //   },
        //   y: {
        //     label: {
        //       text: 'Total Pop.',
        //       position: 'outer-middle'
        //     }
        //   }
        // },
        // area: {
        //   zerobased: false
        // },
        // tooltip: {
        //   show: false
        // },
        // legend: {
        //   show: false
        // },
        // point: {
        //   r: 5,
        //   focus: {
        //     expand: {
        //       r: 15
        //     }
        //   }
        // },
        // zoom: {
        //   enabled: true,
        //   onzoomend: function(d) {
        //
        //   }
        //},
        bindto: "#rank-chart"
      });








    });

    /////////////////////////

    function dailyUpdate(d) {
      // var currentDate = new Date(d.x.toString());
      // console.log(month);
      $("#date").text(d.x.toString().split(" 2020")[0].substring(4));

      // var start = currentYear.toString() + "-01-01";
      // var end = currentYear.toString() + "-12-31";
      //
      //
      //
      // var ticks = [];
      // start = new Date(start.toString());
      // end = new Date(end.toString());
      //
      // s = start.getTime();
      // e = end.getTime();
      // breaks = 5;
      // interval = Math.floor(e - s) / breaks
      // ticks = [];
      // for (var j = 0; j < breaks; j++) {
      //   ticks.push(new Date(s + interval * j))
      // }
      // ticks.push(end);
      //
      // chart.internal.config.axis_x_tick_values = ticks;
      // // chart.flush();
      // chart.zoom([new Date(start.toString()), new Date(end.toString())]);

    }


    $(".leaflet-control-attribution")
      // .css("bottom", "60px")
      .css("background-color", "transparent")
      .html("Supported by <a href='http://hgis.uw.edu'> HGIS Lab @ University of Washigton -Seattle </a>")
      .html("");
  </script>
</body>

</html>
