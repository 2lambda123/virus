<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta name="author" content="Bo Zhao, Benji Antolin">
  <title>2019 Coronavirous Map</title>
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.5.1/dist/leaflet.css" />
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
  <link href="https://fonts.googleapis.com/css?family=Titillium+Web" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css?family=Oswald&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.10/c3.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/simplebar.css" />
  <link rel="stylesheet" href="css/main.css">
  <!-- <link rel="icon" href="//favicon.ico" type="image/x-icon" /> -->
  <script src="js/simplebar.min.js"></script>
  <script src="https://unpkg.com/d3@5/dist/d3.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/c3/0.7.10/c3.min.js"></script>
  <script src="https://unpkg.com/leaflet@1.5.1/dist/leaflet.js"></script>
  <!-- <script src="js/leaflet.heat.js"></script> -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chroma-js/1.3.4/chroma.min.js"></script>

  <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"></script> -->
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"></script>
  <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/momentjs/latest/moment.min.js"></script> -->

  <!-- <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/daterangepicker/daterangepicker.min.js"></script> -->
  <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/malihu-custom-scrollbar-plugin/3.1.5/jquery.mCustomScrollbar.concat.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ekko-lightbox/5.3.0/ekko-lightbox.min.js"></script> -->
</head>

<body>
  <main>
    <div class="loader"></div>
    <div id="info">
      <div id="title"><i class="fas fa-medkit"></i> 2019 Coronavirous Map

        <span><a href="https://www.facebook.com/uwgeog/" target="_blank"><i class="fab fa-facebook"></i></a></span>
        <span><a href="https://twitter.com/UW" target="_blank"><i class="fab fa-twitter-square"></i></a></span>
        <!-- <span><a data-toggle="modal" data-target="#disclaimer"><i class="nav fas fa-question-circle"></i></a></span> -->
      </div>

      <p><span id="placename">Global Stats.</span> <span id="date"></span></p>
      <span id="hint"> Click a place on the map to see details.</span>
      <div class="card-deck counts">
        <div class="card">
          <div class="card-body confirmed">
            <h5 class="card-title">Confirmed</h5>
          </div>
          <p class="card-text confirmed-count">0</p>
        </div>

        <div class="card">
          <div class="card-body suspected">
            <h5 class="card-title">Suspected</h5>
            <p class="card-text suspected-count">0</p>
          </div>
        </div>
        <div class="card">
          <div class="card-body recovered">
            <h5 class="card-title">Recovered</h5>
            <p class="card-text recovered-count">0</p>
          </div>
        </div>

        <div class="card">
          <div class="card-body death">
            <h5 class="card-title">Death</h5>
            <p class="card-text death-count">0</p>
          </div>
        </div>
      </div>

      <div id="timeline-chart"></div>
      <div id="total-chart"></div>
      <div id="rank-chart"></div>

      <div id="footer">
        <p><a href="https://hgis.uw.edu" target="_blank"><img src="img/logo.png" width="250px"></img></a></p>
        <p>Made By <a href="http://hgis.uw.edu">Humanistic GIS Lab at University of Washington - Seattle</a>.</p>
        <p>Data sources: WHO, CDC, NHC, JHU CSSE and Dingxiangyuan.</p>
        <p>Platform is made of CartoDB, Leaflet, D3, C3, bootstrap, and chroma. </p>

      </div>
    </div>

    <div id="map"></div>

    <div id="legend-panel">


      <div class="card-deck legend">


        <div class="card">
          <div class="card-body legend-color-1">
            <h5 class="card-title" style="color:black">0</h5>

          </div>
        </div>

        <div class="card">
          <div class="card-body  legend-color-2">
            <h5 class="card-title" style="color:black">10</h5>

          </div>
        </div>
        <div class="card">
          <div class="card-body  legend-color-3">
            <h5 class="card-title" style="color:black">25</h5>

          </div>
        </div>

        <div class="card">
          <div class="card-body  legend-color-4">
            <h5 class="card-title" style="color:black">50</h5>

          </div>
        </div>

        <div class="card">
          <div class="card-body legend-color-5">
            <h5 class="card-title" style="color:black">100+</h5>
          </div>
        </div>
      </div>


    </div>
  </main>

  <script>
    $(window).ready(function() {
      $('.loader').fadeOut("slow");
    });

    var createLabelIcon = function(labelClass, labelText) {
      return L.divIcon({
        className: labelClass,
        html: labelText
      })
    }

    var mymap = L.map('map', {
      center: [31.448, 105.765],
      zoomControl: false,
      zoom: 5.5,
      maxZoom: 16,
      minZoom: 1,
      worldCopyJump: true
    });


    new L.Control.Zoom({
      position: 'topright'
    }).addTo(mymap);



    var gray = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png').addTo(mymap);
    var streets = L.tileLayer('http://{s}.basemaps.cartocdn.com/rastertiles/voyager_nolabels/{z}/{x}/{y}@2x.png');
    var satellite = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    var baseLayers = {
      'Grayscale': gray,
      'Streets': streets,
      'Satellite': satellite
    }


    var chart, tchart, rchart;


    var colors = chroma.scale('YlOrRd').mode('lch').colors(7);
    for (i = 0; i < 5; i++) {
      $('head').append($("<style> .region-color-" + (i + 1).toString() + " { color: " + colors[i] + "; font-size: 15px; text-shadow: 0 0 3px #ffffff;} </style>"));
      $('head').append($("<style> .legend-color-" + (i + 1).toString() + " { background: " + colors[i] + "; font-size: 15px; text-shadow: 0 0 3px #ffffff;} </style>"));
    }

    Promise.all([
      d3.csv('assets/2019-nCoV.csv'),
      d3.json("assets/wuhan.geojson")
    ]).then(function(datasets) {

      $("#date").text(datasets[0][datasets[0].length - 1]["datetime"].toString().split(" 2020")[0].substring(4));

      $("#date").text("last update on " + Date(datasets[0][datasets[0].length - 1]["datetime"]).toString().split(" 2020")[0].substring(4));


      var t = ["t"];
      var confirmed = ["Confirmed"];
      var suspected = ["Suspected"];
      var recovered = ["Recovered"];
      var death = ["Death"]
      var global = {
        name: "global",
        c: confirmed,
        s: suspected,
        r: recovered,
        d: death

      }



      function calCounts(i) {
        cf = 0, sp = 0, rc = 0, dd = 0;
        datasets[0].forEach(function(d) {
          t.push(new Date(d["datetime"]));
          cf = 0, sp = 0, rc = 0, dd = 0;
          current = d;
          delete current["datetime"];
          if (i["name"] != "global") {
            d = current[i["name"]];
            if (d == undefined) {
              d = "0"
            };
            items = d.split("-");
            switch (items.length) {
              case 4:
                dd += +items[3];
              case 3:
                rc += +items[2];
              case 2:
                sp += +items[1];
              case 1:
                cf += +items[0];
                break;
            }

          } else {

            Object.values(current).forEach(function(d) {
              if (d == undefined) {
                d = "0"
              };
              items = d.split("-");
              switch (items.length) {
                case 4:
                  dd += +items[3];
                case 3:
                  rc += +items[2];
                case 2:
                  sp += +items[1];
                case 1:
                  cf += +items[0];
                  break;
              }
            });
          }

          i["c"].push(cf);
          i["s"].push(sp);
          i["r"].push(rc);
          i["d"].push(dd);

        });

        $(".confirmed-count").text(cf);
        $(".suspected-count").text(sp);
        $(".recovered-count").text(rc);
        $(".death-count").text(dd);


        $("#placename").text(i["name"].toUpperCase() + " Stats");


      }


      function setColor(enname) {
        var id = 0;
        var pop = datasets[0][datasets[0].length - 1][enname];

        if (pop != undefined) {
          pop = +pop.toString().split("-")[0];
        } else {
          pop = 0;
          // return "#00000000";
        }

        if (pop >= 100) {
          id = 4;
        } else if (pop > 50 && pop <= 99) {
          id = 3;
        } else if (pop > 25 && pop <= 50) {
          id = 2;
        } else if (pop > 10 && pop <= 25) {
          id = 1;
        } else if (pop > 0 && pop <= 10) {
          id = 0;
        } else {
          id = -1;
          return "#00000000";
        }

        return colors[id];



      }


      function style(feature) {
        return {
          fillColor: setColor(feature.properties.enname),
          fillOpacity: 0.4,
          weight: 2,
          opacity: 1,
          color: '#b4b4b4',
          dashArray: '3'
        };
      }



      function highlightFeature(e) {
        // e indicates the current event
        var layer = e.target; //the target capture the object which the event associates with
        layer.setStyle({
          weight: 4,
          opacity: 0.8,
          color: '#e3e3e3',
          fillColor: 'yellow',
          fillOpacity: 0.8
        });
        // bring the layer to the front.
        layer.bringToFront();
        // e.target.feature.properties.enname
        // select the update class, and update the contet with the input value.

        // $(".update").html('<b>' + layer.feature.properties.name + '</b>   ' + layer.feature.properties.density + ' people / mi<sup>2</sup>');


      }

      // 3.2.2 zoom to the highlighted feature when the mouse is clicking onto it.
      function zoomToFeature(e) {
        // mymap.fitBounds(e.target.getBounds());

        $("#hint").text("click here to reset.");



        var t = ["t"];
        var confirmed = ["Confirmed"];
        var suspected = ["Suspected"];
        var recovered = ["Recovered"];
        var death = ["Death"]
        var place = {
          name: e.target.feature.properties.enname,
          c: confirmed,
          s: suspected,
          r: recovered,
          d: death
        }

        calCounts(place);



        chart.load({
          columns: [place.c, place.s, place.r, place.d],
          unload: ['Confirmed', 'Suspected', 'Recovered', 'Death'],
        });

      }

      // 3.2.3 reset the hightlighted feature when the mouse is out of its region.
      function resetHighlight(e) {
        provinces.resetStyle(e.target);

      }

      // 3.3 add these event the layer obejct.
      function onEachFeature(feature, layer) {
        layer.on({
          mouseover: highlightFeature,
          click: zoomToFeature,
          mouseout: resetHighlight
        });
      }


      var provinces = L.geoJSON(datasets[1], {
        style: style,
        onEachFeature: onEachFeature
      }).addTo(mymap);

      // mymap.fitBounds(provinces.getBounds());


      // L.tileLayer('https://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}{r}@2x.png').addTo(mymap);

      // L.control.layers(provinces, {
      //   collapsed: false
      // }).addTo(mymap);


      $("#hint").on("click", function() {
        calCounts(global);

      });
      calCounts(global);


      console.log(cf);



      chart = c3.generate({
        size: {
          width: 440
        },
        data: {
          x: "t",
          y: "confirmed",
          columns: [t, global.c, global.s, global.r, global.d],
          type: 'line',
          axes: {
            confirmed: 'y'
          },
          colors: {
            Confirmed: '#dc3545',
            Suspected: 'orange',
            Recovered: '#28a745',
            Death: '#5d4f72e8'
          }
        },
        axis: {
          x: {
            type: "timeseries",
            tick: {
              format: "%b %d",
              fit: true
            }
          },
          y: {
            label: {
              text: 'Total Pop.',
              position: 'outer-middle'
            }
          }
        },
        point: {
          r: 5,
          focus: {
            expand: {
              r: 2
            }
          }
        },
        zoom: {
          // rescale: true,
          enabled: false,
          type: "scroll",
          // onzoom: function(d) {
          //   tt(d);
          // }
        },
        tooltip: {
          linked: true,
        },
        legend: {
          position: 'inset',
          inset: {
            anchor: "top-left",
            y: 10,
          },
        },
        bindto: "#total-chart"
      });


      // https://c3js.org/samples/axes_x_tick_rotate.html
      rchart = c3.generate({
        size: {
          height: 300,
          width: 440
        },
        data: {
          x: 'x',
          columns: [
            ['x', 'China', 'Thailand', 'Japan', 'Malaysia', 'Singapore', 'Australia', 'U.S.', 'South Korea', 'France'],
            ['Total Confirmed Pop.', 2079, 8, 4, 4, 4, 4, 3, 3, 3]
          ],
          type: 'bar'
        },
        axis: {
          x: {
            type: 'category',

            tick: {
              rotate: -60,
              multiline: false
            }
          },
          y: {
            label: {
              text: 'Total Confirmed Pop.',
              position: 'outer-middle'
            },
            tick: {
              values: [10, 50, 100, 500, 2000]
            },
            type: 'log'
          }
        },
        legend: {
          show: false
        },
        bindto: "#rank-chart"
      });

    });

    /////////////////////////

    function dailyUpdate(d) {
      // var currentDate = new Date(d.x.toString());
      // console.log(month);
      $("#date").text(d.x.toString().split(" 2020")[0].substring(4));

      // var start = currentYear.toString() + "-01-01";
      // var end = currentYear.toString() + "-12-31";
      //
      //
      //
      // var ticks = [];
      // start = new Date(start.toString());
      // end = new Date(end.toString());
      //
      // s = start.getTime();
      // e = end.getTime();
      // breaks = 5;
      // interval = Math.floor(e - s) / breaks
      // ticks = [];
      // for (var j = 0; j < breaks; j++) {
      //   ticks.push(new Date(s + interval * j))
      // }
      // ticks.push(end);
      //
      // chart.internal.config.axis_x_tick_values = ticks;
      // // chart.flush();
      // chart.zoom([new Date(start.toString()), new Date(end.toString())]);

    }


    $(".leaflet-control-attribution")
      // .css("bottom", "60px")
      .css("background-color", "transparent")
      .html("Supported by <a href='http://hgis.uw.edu'> HGIS Lab @ University of Washigton -Seattle </a>")
      .html("");
  </script>
</body>

</html>
